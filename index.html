<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlocklyQL</title>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="src/custom-blocks.js"></script>
    
    <link rel="stylesheet" type="text/css" href="src/style.css">
</head>
<body>
    <h1>BlocklyQL</h1>
    
    <div class="row">
        <div id="blocklyDiv" class="full-width">
            <xml id="toolbox" style="display: none;">
                <block type="execute"></block>
                <block type="SELECT-FROM"></block>
                <block type="attribute"></block>
                <block type="table"></block>
                <block type="comparison"></block>
                <block type="WHERE"></block>
                <block type="target"></block>
                <block type="AGGREGATE"></block>
                <!-- Add more blocks for other SQL constructs -->
            </xml>
        </div>  
    </div>
    <div class="row button-row">
        <button onclick="generateCode()">Generate JS code</button>
        <button onclick="runCode()">Run JS code</button>
        <button onclick="saveCode()">save JS code</button>
        <!-- <button onclick="saveBlocks()">Save Blocks</button>
        <button onclick="loadBlocks()">Load Blocks</button> -->
        <!-- <input type="file" id="loadInput" style="display: none;" onchange="loadBlocksFile(event)"> -->
    </div>
    <div class="row">
        <div id="codeDiv" class="half-width"></div>
        <div id="outputDiv" class="half-width"></div>
    </div>
    
    <!-- Load Blockly workspace with the toolbox -->
    <script>
        // Create a workspace with the defined toolbox
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            scrollbars: true
        });
        
        var xmlString = '<xml xmlns="https://developers.google.com/blockly/xml"><block type="execute" id="|*nT426^Js?MG3aO+bXD" x="68" y="78"><value name="Query"><block type="SELECT-FROM" id="7znB^lm.*76=$cfE_3rX"><value name="SELECT"><block type="attribute" id="k)Q]$^YH;K77M[S%?:31"><field name="Attribute">All</field></block></value><value name="FROM"><block type="table" id="_OOsz0y!G?ZALI6*!p:0"><field name="Table">astronaut</field></block></value><value name="FILTER"><block type="WHERE" id="34]XcW`TtIr![l!:R#l;"><value name="attribute"><block type="attribute" id="`GlEV(Y@Azy0HEW_ymdz"><field name="Attribute">age</field></block></value><value name="comparison"><block type="comparison" id="`DAMFOW@Azy0HEWDMIF)"><field name="OPERATOR">'>'</field></block></value><value name="target"><block type="target" id="`JMKSL@)FLn0HEWDMIF)"><field name="var">50</field></block></value></block></value></block></value></block></xml>';
        var parser = new DOMParser();
        var xmlDoc = parser.parseFromString(xmlString, "text/xml");
        var serializer = new XMLSerializer();
        window.defaultBlocks = serializer.serializeToString(xmlDoc);

        function generateCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            document.getElementById('codeDiv').innerText = code;
        }

        function runCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            try {
                var output = eval(code);
                document.getElementById('outputDiv').innerText = output;
            } catch (e) {
                document.getElementById('outputDiv').innerText = 'Error: ' + e;
            }
        }
        function saveCode() {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
        
            // Specify the desired file name for the js file
            var fileName = 'query.js';

            // Call the function to save the js code to a file
            saveSQLToFile(code, fileName);
        }

        function saveSQLToFile(sqlCode, fileName) {
            // Create a Blob (Binary Large Object) containing the js code
            var blob = new Blob([sqlCode], { type: 'text/js' });

            // Create a temporary URL for the Blob
            var url = URL.createObjectURL(blob);

            // Create a hidden anchor element for downloading the file
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName; // Set the desired file name

            // Trigger a click event on the anchor element to initiate the download
            a.click();

            // Release the Blob and URL resources
            URL.revokeObjectURL(url);
        }

        workspace.addChangeListener(function(event) {
            // Handle changes in the workspace, generate SQL, etc.
        });
    </script>
</body>
</html>